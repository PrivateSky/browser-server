<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
<div id="log"></div><button id="doRequestButton">Do request</button>

<script>
    let iframeCodeVersion = "iframeCode-v4";
    let search = window.location.search;
    let appName = search.substring(1);
    //document.getElementById("version").innerText = iframeCodeVersion + " : " + appName;
    console.log("Loading iframe:", iframeCodeVersion)

    var registrationScopes = [];
    function listScopes(){
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
            registrationScopes = registrations.map(function (registration) {
                return registration.scope;
            });
            console.log("Scopurile instalate:", registrationScopes);
        });
    }

    var folderName = "/" + appName + "/"
    //var swPath = "http://localhost:8080" + folderName+'sw.js';
    var swPath = "http://localhost:8080" + '/sw.js';
    window.addEventListener('load', function () {
        console.log("Registering SW for", swPath, folderName);
        navigator.serviceWorker.register(swPath, {scope: folderName} )
            .then(function (registration) {
                    console.log(iframeCodeVersion, ': registration with scope: ', registration.scope);
                    if (registrationScopes.indexOf(registration.scope) == -1) {
                        //window.location.reload();
                    }
                    listScopes();
                },
                function (err) { // registration failed :(
                    console.log('ServiceWorker registration failed: ', err);
                });
    });


    function doLog(str){
        console.log(str);
        let node = document.createTextNode(str+"    ")
        document.getElementById("log").appendChild(node);
    }


    function doRequest(appname){
        setTimeout(function(){
            doLog("Requesting " + "/something in " + appname);
            fetch('/something/'+appname).then(
                function(response) {
                    if(response.status == 200){
                        response.text().then(function(text){
                            doLog(appname + " response is " + text)
                        })
                    } else {
                        doLog(appname + " not found!!!!!!" )
                    }

                }).catch(function(err){
                    console.log(err);
                })
        }, 1);
    }


    document.getElementById("doRequestButton").addEventListener("click",function(){
        doRequest(appName);
    });

    window.addEventListener("message", function(event){
        console.log("Message received in child iframe:", event);
    }, false);


    let spoke;
    import('/HubAndSpoke/HubAndSpoke.js').then((module) => {
        console.log("...");
        spoke = module.createSpoke(window, function(message){
            console.log(appName,"Message from parent ", message, spoke);
            spoke.send({messageFrom:appName});
        })
    }).catch(function(err){
        console.log(err);
    });


</script>

</body>
</html>